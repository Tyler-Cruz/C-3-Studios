<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signature Complexity Analyzer</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <header>
      <div class="header-container">
        <img
          src="../images/CStudiosLogo.png"
          alt="C Studios Logo"
          class="logo"
        />
        <div>
          <h1>Signature Complexity Analyzer</h1>
        </div>
      </div>
    </header>

    <main class="main-layout">
      <!-- Upload Section -->
      <section class="upload-section" id="dropZone">
        <input
          type="file"
          id="signatureInput"
          accept="image/png, image/jpeg"
          multiple
        />
        <label for="signatureInput" class="upload-btn">Choose Signatures</label>
        <p class="drop-text">or drag and drop images here</p>

        <div class="preview" id="previewBox">
          <p>Preview:</p>
          <img id="previewImage" alt="Signature Preview" />
        </div>

        <div class="gallery" id="imageGallery"></div>

        <p class="error-message" id="errorMsg"></p>

        <div class="button-group">
          <button class="analyze-btn" id="analyzeBtn">Analyze</button>
          <button class="clear-btn" id="clearBtn">Clear Results</button>
          <button class="remove-btn" id="removeBtn">Remove From Cache</button>
        </div>

        <p id="progressLabel" class="progress-label"></p>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </section>

      <!-- Results Section -->
      <section class="results-panel">
        <h2>Analysis Results</h2>
        <p>Overall Complexity Score:</p>
        <p class="score" id="complexityScore">--</p>

        <div class="metrics">
          <div class="metric">
            <h3>Pen Lifts</h3>
            <p id="penLifts">--</p>
          </div>
          <div class="metric">
            <h3>Pen Reversals</h3>
            <p id="penReversals">--</p>
          </div>
          <div class="metric">
            <h3>Pen Intersections</h3>
            <p id="penIntersections">--</p>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; C<sup>3</sup> Studios</p>
    </footer>

    <script>
      const analyzeBtn = document.getElementById("analyzeBtn");
      const clearBtn = document.getElementById("clearBtn");
      const input = document.getElementById("signatureInput");
      const previewBox = document.getElementById("previewBox");
      const previewImage = document.getElementById("previewImage");
      const errorMsg = document.getElementById("errorMsg");
      const gallery = document.getElementById("imageGallery");
      const removeBtn = document.getElementById("removeBtn");
      let imagesData = []; // stores { id, file, src, results }
      let currentImageId = null;
      let analyzing = false; // prevent switching during analysis

      // Initially disable buttons
      analyzeBtn.disabled = true;
      clearBtn.disabled = true;
      removeBtn.disabled = true;

      // Enable Analyze button only when a valid file is selected
      // Handle multiple file uploads
      input.addEventListener("change", function () {
        const files = Array.from(this.files);
        errorMsg.textContent = "";

        files.forEach((file) => {
          if (!["image/png", "image/jpeg"].includes(file.type)) {
            errorMsg.textContent =
              "Invalid file type. Please upload PNG or JPEG images.";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const imgId = Date.now() + Math.random(); // unique ID
            const imgSrc = e.target.result;

            imagesData.push({
              id: imgId,
              file: file,
              src: imgSrc,
              results: null,
            });

            // Add thumbnail
            const thumb = document.createElement("img");
            thumb.src = imgSrc;
            thumb.dataset.id = imgId;
            thumb.title = file.name; // Tooltip shows filename initially
            thumb.addEventListener("click", () => {
              if (!analyzing) switchImage(imgId);
            });
            gallery.appendChild(thumb);

            // Set this as the current image and show preview
            currentImageId = imgId;
            previewImage.src = imgSrc;
            previewBox.style.display = "block";
            updateActiveThumbnail();
            analyzeBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        });
      });

      // --- DRAG & DROP MULTI-UPLOAD SUPPORT ---
      const dropZone = document.getElementById("dropZone");

      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("dragover");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("dragover");
        });
      });

      dropZone.addEventListener("drop", (e) => {
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
      });

      // Reuse existing logic for uploads
      function handleFiles(files) {
        errorMsg.textContent = "";

        files.forEach((file) => {
          if (!["image/png", "image/jpeg"].includes(file.type)) {
            errorMsg.textContent =
              "Invalid file type. Please upload PNG or JPEG images.";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const imgId = Date.now() + Math.random(); // unique ID
            const imgSrc = e.target.result;

            imagesData.push({
              id: imgId,
              file: file,
              src: imgSrc,
              results: null,
            });

            // Add thumbnail
            const thumb = document.createElement("img");
            thumb.src = imgSrc;
            thumb.dataset.id = imgId;
            thumb.title = file.name;
            thumb.addEventListener("click", () => switchImage(imgId));
            gallery.appendChild(thumb);

            // Set this as current image
            currentImageId = imgId;
            previewImage.src = imgSrc;
            previewBox.style.display = "block";
            updateActiveThumbnail();
            analyzeBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        });
      }

      // Simulate progress bar and analysis
      function simulateProgress() {
        const bar = document.getElementById("progressBar");
        const label = document.getElementById("progressLabel");

        analyzeBtn.disabled = true; // disable during analysis
        analyzing = true;

        // Disable thumbnail interaction
        document.querySelectorAll(".gallery img").forEach((thumb) => {
          thumb.style.pointerEvents = "none";
          thumb.style.opacity = "0.6";
        });

        bar.classList.remove("complete");
        label.classList.remove("complete");
        label.textContent = "Analyzing...";
        bar.style.width = "0%";

        let width = 0;
        const interval = setInterval(() => {
          if (width >= 100) {
            clearInterval(interval);
            bar.classList.add("complete");
            label.textContent = "Complete!";
            label.classList.add("complete");

            analyzeBtn.disabled = false; // re-enable analyze
            clearBtn.disabled = false; // enable clear

            analyzing = false;
            document.querySelectorAll(".gallery img").forEach((thumb) => {
              thumb.style.pointerEvents = "auto";
              thumb.style.opacity = "1";
            });
          } else {
            width += 5;
            bar.style.width = width + "%";
          }
        }, 100);
      }

      function switchImage(id) {
        const selected = imagesData.find((img) => img.id === id);
        if (!selected) return;

        currentImageId = id;
        previewImage.src = selected.src;
        previewBox.style.display = "block";
        updateActiveThumbnail();
        removeBtn.disabled = false;

        // Show that image's results if available
        if (selected.results) {
          displayResults(selected.results);
          clearBtn.disabled = false;
        } else {
          resetResultsDisplay();
          clearBtn.disabled = true;
        }
      }

      function updateActiveThumbnail() {
        document.querySelectorAll(".gallery img").forEach((thumb) => {
          thumb.classList.toggle("active", thumb.dataset.id == currentImageId);
        });
      }

      function displayResults(results) {
        document.getElementById("complexityScore").textContent = results.score;
        document.getElementById("penLifts").textContent = results.lifts;
        document.getElementById("penReversals").textContent = results.reversals;
        document.getElementById("penIntersections").textContent =
          results.intersections;
      }

      function resetResultsDisplay() {
        document.getElementById("complexityScore").textContent = "--";
        document.getElementById("penLifts").textContent = "--";
        document.getElementById("penReversals").textContent = "--";
        document.getElementById("penIntersections").textContent = "--";
      }

      // Analyze button click
      analyzeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (!currentImageId || imagesData.length === 0) {
          errorMsg.textContent =
            "Please select or upload a file before analyzing.";
          return;
        }

        errorMsg.textContent = "";
        simulateProgress();

        // Fill in results after progress finishes
        setTimeout(() => {
          const newResults = {
            score: "78.5",
            lifts: "3",
            reversals: "12",
            intersections: "5",
          };

          // Save results to current image
          const img = imagesData.find((img) => img.id === currentImageId);
          if (img) img.results = newResults;

          // Update thumbnail tooltip with score
          const thumb = gallery.querySelector(
            `img[data-id='${currentImageId}']`
          );
          if (thumb) {
            thumb.title = `${img.file.name} — Score: ${newResults.score}`;
          }

          displayResults(newResults);
          clearBtn.disabled = false;
        }, 2200);
      });

      // Clear button click
      clearBtn.addEventListener("click", function () {
        // Clear current image’s results, progress, and preview
        const progressBar = document.getElementById("progressBar");
        const progressLabel = document.getElementById("progressLabel");

        // Reset visual elements
        progressBar.style.width = "0%";
        progressBar.classList.remove("complete");
        progressLabel.textContent = "";
        progressLabel.classList.remove("complete");

        // Clear results for that image
        if (currentImageId) {
          const img = imagesData.find((img) => img.id === currentImageId);
          if (img) img.results = null;
        }

        resetResultsDisplay();
        clearBtn.disabled = true;
        removeBtn.disabled = !currentImageId;
      });

      // Remove From Cache button click
      removeBtn.addEventListener("click", () => {
        if (!currentImageId) return;

        // Remove from imagesData array
        imagesData = imagesData.filter((img) => img.id !== currentImageId);

        // Remove thumbnail element
        const thumb = gallery.querySelector(`img[data-id='${currentImageId}']`);
        if (thumb) thumb.remove();

        // Reset preview and results
        resetResultsDisplay();
        previewBox.style.display = "none";

        // Disable all control buttons
        clearBtn.disabled = true;
        analyzeBtn.disabled = true;
        removeBtn.disabled = true;

        // If there are other images, select the first one
        if (imagesData.length > 0) {
          switchImage(imagesData[0].id);
        } else {
          currentImageId = null;
        }
      });
    </script>
  </body>
</html>
